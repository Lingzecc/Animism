<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
  <title>Ciallo～ (∠・ω< )⌒★</title>
</head>
<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/extra.min.js"></script>
<script src="https://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/audiocontext/2.1.0/AudioContext.min.js"></script>
<style>
  #audio {
    display: none;
  }

  .input-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 300px;
    height: 50px;
    background-color: #f6f2f289;
    padding: 25px;
    margin-bottom: 10px;
    border-radius: 10px;
  }

  #text {
    width: 100%;
    height: 100%;
    border: none;
    padding: 0;
    margin: 0;
    background-color: transparent;
    position: absolute;
    top: 0;
    left: 0;
    text-align: center;
    border-radius: 10px;
  }

  .text {
    position: absolute;
    right: 20px;
    bottom: 10px;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    background-color: #4CAF50;
    /* 修改为绿色 */
    color: white;
  }

  .voice {
    position: absolute;
    right: 20px;
    top: 10px;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    background-color: #337AB7;
    /* 修改为蓝色 */
    color: white;
  }

  .input-container {
    display: flex;
    /* 使用Flexbox */
    align-items: center;
    /* 使子元素在交叉轴上的对齐方式为中心 */
  }

  .input-container input {
    flex: 1;
    /* 输入框占据除控件外的所有剩余空间 */
    margin-right: 10px;
    /* 右边距，给控件留出空间 */
  }

  .controls {
    display: flex;
    /* 控件内部也使用Flexbox布局 */
    gap: 20px;
    /* 控件之间的间距 */
  }
</style>
<div class="input-container">
  <input type="text" id="text" placeholder="输入文字">
  <button class="text" onclick="speak()">发送</button>
  <audio id="audio" controls></audio>
  <button class="voice" id="recordButton">语音</button>
</div>
<canvas id="canvas" width="800" height="600"></canvas>

<script>




  // 录音块

  let mediaRecorder;
  let audioChunks = [];
  let isRecording = false;



  const startRecording = async () => {
    isRecording = true;
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = event => {
      if (event.data.size > 0) {
        audioChunks.push(event.data);
      }
    };

    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunks, { type: "audio/webm; codecs=opus" });
      const audioFormData = new FormData();
      audioFormData.append('audioFile', audioBlob, 'recorded_audio.webm');

      try {
        await fetch('/upload/audio', {
          method: 'POST',
          body: audioFormData,
        });
        console.log('音频文件上传成功！');
      } catch (error) {
        console.error('上传失败:', error);
      }

      // 清理资源  
      audioChunks = [];
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
      mediaRecorder = null; // 可选：重置mediaRecorder为null  
      isRecording = false; // 更新录音状态  
    };

    mediaRecorder.start();
    console.log("录音开始");
  };

  const stopRecording = () => {
    mediaRecorder.stop();
    console.log("录音停止");
  };



  const startOrStopRecording = async () => {
    if (!isRecording) {
      startRecording();
    } else {
      stopRecording();
    }
  };

  // 绑定按钮点击事件  
  document.getElementById('recordButton').addEventListener('click', startOrStopRecording);




  // 音频播放块
  function speak() {
    const text = document.getElementById('text').value;
    fetch('/upload/tts', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: `text=${encodeURIComponent(text)}`
    })
      .then(response => response.blob())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        const audio = document.getElementById('audio');
        audio.src = url;
        audio.play();
        // 调用 /mouthY 路由  
        fetch('/mouthY', {  
            method: 'POST' // 假设这是一个GET请求，根据你的API调整  
        })  
        .then(response => {  
            if (!response.ok) {  
                throw new Error('Network response was not ok');  
            }  
            // 处理响应，如果需要的话  
            console.log('Successfully called /mouthY');  
        })  
        .catch(error => console.error('There was a problem with your fetch operation:', error));
      });
  }


  // 皮套块

  // 将 PIXI 暴露到 window 上，这样插件就可以通过 window.PIXI.Ticker 来自动更新模型
  window.PIXI = PIXI;
  const live2d = PIXI.live2d;
  (async function main() {
    const app = new PIXI.Application({
      view: document.getElementById("canvas"),
      autoStart: true,
      resizeTo: window,
      backgroundColor: 0x333333
    });
    // 皮套路径
    const models = await Promise.all([
      live2d.Live2DModel.from("assets/ariu/ariu.model3.json")
    ]);

    models.forEach((model) => {
      app.stage.addChild(model);
      const scaleX = (window.innerWidth * 1) / model.width;
      const scaleY = (window.innerHeight * 2.5) / model.height;

      // 模型大小
      model.scale.set(Math.min(scaleX, scaleY));
      //模型位置坐标
      model.y = innerHeight * 0.01;
      model.x = innerWidth * 0.125;
      // 口型大小定义
      const setMouthOpenY = v => {
        v = Math.max(0, Math.min(1, v));
        model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', v);
      }


      // ajax异步——口型检测
      // 引用自https://juejin.cn/post/7242279345136861241
      setInterval(() => {
        $.ajax({
          type: "GET",
          url: "/api/mouth",
          dataType: 'json',
          success(data) {
            // 调用口型函数，7毫秒请求一次tmp.txt文件获取口型数值
            setMouthOpenY(parseFloat(data.y))
          }
        });
      }, 7); // 每7毫秒检查一次


    });

  })();

</script>