<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
  <title>Ciallo～ (∠・ω< )⌒★</title>
</head>
<script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display/dist/extra.min.js"></script>
<script src="https://libs.baidu.com/jquery/2.1.4/jquery.min.js"></script>
<canvas id=canvas></canvas>
<button id="shoubing">手柄</button>
<button id="jkbao">jkbao</button>
<button id="zhangzui">张嘴</button>
<button id="bizui">闭嘴</button>
<button id="start">开始录音</button>
<button id="stop">停止录音</button>
<div id="control"></div>


<script>
  let mediaRecorder;
  let audioChunks = [];

  const startRecording = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = event => {
      if (event.data.size > 0) {
        audioChunks.push(event.data);
      }
    };

    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunks, { type: "audio/webm; codecs=opus" });
      const formData = new FormData();
      formData.append('audioFile', audioBlob, 'recorded_audio.webm');

      try {
        await fetch('/upload', {
          method: 'POST',
          body: formData,
        });
        console.log('音频文件上传成功！');
      } catch (error) {
        console.error('上传失败:', error);
      }

      // 清理资源  
      audioChunks = [];
      mediaRecorder.stream.getTracks().forEach(track => track.stop());
    };

    mediaRecorder.start();
    console.log("录音开始");
  };

  const stopRecording = () => {
    mediaRecorder.stop();
    console.log("录音停止");
  };

  document.getElementById('start').addEventListener('click', startRecording);
  document.getElementById('stop').addEventListener('click', stopRecording);

  // 将 PIXI 暴露到 window 上，这样插件就可以通过 window.PIXI.Ticker 来自动更新模型
  window.PIXI = PIXI;
  const live2d = PIXI.live2d;

  (async function main() {
    const app = new PIXI.Application({
      view: document.getElementById("canvas"),
      autoStart: true,
      resizeTo: window,
      backgroundColor: 0x333333
    });

    const models = await Promise.all([
      live2d.Live2DModel.from("assets/ariu/ariu.model3.json")
      // live2d.Live2DModel.from("https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/shizuku/shizuku.model.json")
    ]);

    models.forEach((model) => {
      app.stage.addChild(model);

      const scaleX = (innerWidth * 1) / model.width;
      const scaleY = (innerHeight * 2.5) / model.height;

      // 模型大小
      model.scale.set(Math.min(scaleX, scaleY));
      //模型位置坐标
      model.y = innerHeight * 0.01;
      model.x = innerWidth * 0.125;
      document.getElementById("shoubing").onclick = () => {
        model.expression("shoubing");
      }
      document.getElementById("jkbao").onclick = () => {
        model.expression("jkbao");
      }
      // 1张嘴0闭嘴
      document.getElementById("zhangzui").onclick = () => {
        setMouthOpenY(1)
      }
      document.getElementById("bizui").onclick = () => {
        setMouthOpenY(0)
      }
      // 口型大小定义
      const setMouthOpenY = v => {
        v = Math.max(0, Math.min(1, v));
        model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', v);
      }
      // ajax异步检测
      setInterval(() => {
        $.ajax({
          type: "GET",
          url: "/api/get_mouth_y",
          dataType: 'json',
          async: true,
          success(data) {
            setMouthOpenY(parseFloat(data.y))
            if (parseFloat(data.y) !== 0) {
              // 如果y值不是0，播放音频  
              if (audioElement.paused) {
                var audioElement = new Audio('/audio/tmp.wav');
                audioElement.play();
              }
            }
          },
        });
      }, 10)


    });

  })();
</script>